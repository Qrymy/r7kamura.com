<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width">
  <title>rails_kwargs_testing で緩やかに Rails 5 向けのテストコードに移行する</title>
  <link href="https://r7kamura.com/articles/2018-04-21-rails-kwargs-testing-rails-5-9056e5284965" rel="canonical">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="search" type="application/opensearchdescription+xml" title="r7kamura.com" href="/opensearch.xml">
  <link rel="alternate" type="application/rss+xml" href="/feed.xml">
  
  <meta property="description" content="rails_kwargs_testing という gem の紹介記事です。">
  <meta property="og:description" content="rails_kwargs_testing という gem の紹介記事です。">
  
  <meta property="og:type" content="website">
  <meta property="og:title" content="rails_kwargs_testing で緩やかに Rails 5 向けのテストコードに移行する">
  <meta property="og:url" content="https://r7kamura.com/articles/2018-04-21-rails-kwargs-testing-rails-5-9056e5284965">
  
  <meta property="og:image" content="https://r7kamura.com/default_og_image.jpg">
  <meta property="twitter:card" content="summary">
  
</head>
<body>
  <header>
    <nav>
      <a href="/">r7kamura</a>
      <ul>
        <li>
          <a href="/articles">記事</a>
        </li>
        <li>
          <a href="https://google.com/search?q=site:r7kamura.com">検索</a>
        </li>
      </ul>
    </nav>
  </header>
  <main>
    <article>
  <h1>rails_kwargs_testing で緩やかに Rails 5 向けのテストコードに移行する</h1>
  <footer>
    <p>
      <time datetime="2018-04-21T00:00:00+00:00">2018年04月21日</time>
    </p>
  </footer>
  <div>
    <p>rails_kwargs_testing という gem の紹介記事です。</p>

<p><a href="https://github.com/r7kamura/rails_kwargs_testing" title="https://github.com/r7kamura/rails_kwargs_testing"><strong>r7kamura/rails_kwargs_testing</strong><br>
<em>Provides Rails 5 compatible testing methods for gradual migration from Rails 4 to 5. - r7kamura/rails_kwargs_testing</em>github.com</a><a href="https://github.com/r7kamura/rails_kwargs_testing"></a></p>

<h2>Rails 4 から 5 でテストで使う HTTP メソッドの引数が変わった</h2>

<p>Rails 4 から 5 にかけて、ActionController::TestCase と ActionDispatch::IntegrationTest の #get や #post などのメソッドの引数の形式が変わり、Rails 5 ではキーワード引数を利用するようになりました。RSpec であれば、ActionController::TestCase は controller-specs、ActionDispatch::IntegrationTest は request-specs で利用するやつです。</p>

<p><a href="https://github.com/rails/rails/pull/18323" title="https://github.com/rails/rails/pull/18323"><strong>Use kwargs in ActionController::TestCase and ActionDispatch::Integration HTTP methods by kirs ·…</strong><br>
<em>As @dhh suggested, controller HTTP methods are a prime candidate for kwargs. post url, nil, nil, { a: ‘b’ } doesn’t…</em>github.com</a><a href="https://github.com/rails/rails/pull/18323"></a></p>

<h2>Rails 4 でも rails_kwargs_testing でキーワード引数を使う</h2>

<p>Rails 4 から 5 への変更と共に、全ての引数の形式を書き換える変更を同時に入れることも可能です。しかし、Rails 4 から 5 への移行は比較的長い時間をかけて行われることが多く、他のブランチでテストが追加あるいは変更される中でこの手の変更を加えると、merge 時に問題が起きたり、conflict が発生したりする可能性が高まってしまいます。また、レビューの難しさや問題発生時の対処のことなども考えると、可能であれば Rails 4 と 5 で両方動く変更は先に加えておき、バージョン変更時の差分はできるだけ小さくしておきたいものです。</p>

<p>こういった背景から、Rails 4 の状態で引数の形式だけを変更しておきたいという需要があり、rails_kwargs_testing という gem をつくりました。実際には、業務委託で色々なサービスの Rails のバージョンを上げる仕事を請け負っている中で、これまで使ってきたコードをライブラリとしてまとめたような形になってます。</p>

<p><a href="https://github.com/r7kamura/rails_kwargs_testing" title="https://github.com/r7kamura/rails_kwargs_testing"><strong>r7kamura/rails_kwargs_testing</strong><br>
<em>rails_kwargs_testing — Provides Rails 5 compatible testing methods for gradual migration from Rails 4 to 5.</em>github.com</a><a href="https://github.com/r7kamura/rails_kwargs_testing"></a></p>

<h2>使い方</h2>

<p>README を読めば分かるようになっていますが、補足も含めて少し説明しておきます。rspec-rails を一般的な形で使っているとして、まずは Gemfile の :test group に rails_kwargs_testing を追加したあと、spec/rails_helper.rb で rails_kwargs_testing から提供されている module を prepend します。</p>

<p>RSpec.configure do |config|<br>
  config.prepend RailsKwargsTesting::ControllerMethods, type: :controller<br>
  config.prepend RailsKwargsTesting::RequestMethods, type: :request<br>
end</p>

<p>controller-specs には RailsKwargsTesting::ControllerMethods を、request-specs には RailsKwargsTesting::RequestMethods を prepend しています。これで #get や #post などのメソッドがキーワード引数だけを取るように上書きされます。</p>

<p>次にメソッドの引数を全てキーワード引数形式に変更し、全てのテストが成功することを確認すれば完了です。変更しなければ ArgumentError が発声します。コードの変更には rails5-spec-converter を利用するのが良いと思います。コンマの扱いなどに少し不具合はありますが、それを差し置いても非常に便利なツールです。</p>

<p><a href="https://github.com/tjgrathwell/rails5-spec-converter" title="https://github.com/tjgrathwell/rails5-spec-converter"><strong>tjgrathwell/rails5-spec-converter</strong><br>
<em>rails5-spec-converter — A tool to upgrade Rails 4-style specs to Rails 5-style</em>github.com</a><a href="https://github.com/tjgrathwell/rails5-spec-converter"></a></p>

<p>全てのテストが成功することを確認したら、主流の開発用ブランチへ変更を merge し、Rails 5 への残りの移行作業をがんばって進めましょう。</p>

  </div>
</article>

  </main>
</body>
</html>
