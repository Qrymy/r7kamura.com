<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width">
  <title>ResponseCodeMatchers.gem</title>
  <link href="/articles/2012-11-28-h" rel="canonical">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="search" type="application/opensearchdescription+xml" title="r7kamura.com" href="/opensearch.xml">
  <link rel="alternate" type="application/rss+xml" href="/feed.xml">
  <meta property="description" content="https:&#x2F;&#x2F;github.com&#x2F;r7kamura&#x2F;response_code_matchers">
  <meta property="og:description" content="https:&#x2F;&#x2F;github.com&#x2F;r7kamura&#x2F;response_code_matchers">
  <meta property="og:type" content="article">
  <meta property="og:title" content="ResponseCodeMatchers.gem">
  <meta property="og:url" content="https://r7kamura.com/articles/2012-11-28-h">
  <meta property="og:image" content="https://r7kamura.com/default_og_image.jpg">
  <meta property="twitter:card" content="summary">
</head>
<body>
  <header>
    <nav>
      <a href="/">r7kamura</a>
      <ul>
        <li>
          <a href="/articles">記事</a>
        </li>
        <li>
          <a href="https://google.com/search?q=site:r7kamura.com">検索</a>
        </li>
      </ul>
    </nav>
  </header>
  <main>
    <article>
  <h1>ResponseCodeMatchers.gem</h1>
  <footer>
    <p>
      <time datetime="2012-11-28T00:00:00+09:00">2012年11月28日</time>
    </p>
  </footer>
  <div>
    <p><a href="https://github.com/r7kamura/response_code_matchers">https://github.com/r7kamura/response_code_matchers</a><br>
夕方ぐらいにControllerのspecを書いていて「subject.code.should == "422"...」みたいなコードを書いていて、急に思い立って初めてCustom MatcherをつくってGemにした。</p><p></p>

<div class="section">
    <h3>使い方</h3>
    <p>spec_helper.rbでこういう感じで設定すると使えるようになる。</p>
<pre class="code" data-unlink># spec/spec_helper.rb
require "response_code_matchers"

<p>RSpec.configure do |config|
  config.include ResponseCodeMatchers
end</pre></p>
<p><br>
今まではresponse.code.should == "422"って書いてたのを、こういう風に書けるようになる。Railsのcontrollerのspecだと、postやgetがresponseオブジェクトを返す。自分は大体subjectでpostやgetを呼ぶことが多いので、そういうときに良い感じに書ける。</p>
<p></p>
<pre class="code" data-unlink># spec/controllers/blogs_controller.rb
describe BlogsController do
  describe "#create" do
    subject do
      post :create, params
    end

<pre><code>let(:params) do
  { :title =&amp;gt; &quot;title&quot;, :body =&amp;gt; &quot;body&quot;, :token =&amp;gt; &quot;token&quot;, :user_id =&amp;gt; 1 }
end

# 201
context &quot;with valid token&quot; do
  it { should be_created }
end

# 400
context &quot;without user_id&quot; do
  before do
    params.delete(:user_id)
  end

  it { should be_bad_request }
end

# 401
context &quot;with invalid token&quot; do
  before do
    params[:token] = &quot;invalid&quot;
  end

  it { should be_unauthorized }
end</code></pre><p>  end
end</pre></p>
</div>
<div class="section">
    <h3>実装</h3>
    <p>RackがHTTPステータスコードと名前の対応表を持っているので、それを利用してMatcherをつくる。<br>
<a href="https://github.com/rack/rack/blob/master/lib/rack/utils.rb#L548">https://github.com/rack/rack/blob/master/lib/rack/utils.rb#L548</a></p>
<p>CustomMatcherは2通りの作り方がある。<br>
1つはRSpec::Matchers.defineで簡単につくる方法。<br>
1つはMatcher用のmodule + classを用意してあげる方法。</p>
<pre class="code" data-unlink>RSpec::Matchers.define :be_a_multiple_of do |expected|
  match do |actual|
    actual % expected == 0
  end
end</pre>
<p><br>
Matchersモジュールは、Matcherクラスのインスタンスを返すようなmatcherメソッドを定義すれば良い。<br>
Matcherクラスは、以下のメソッドを持っていれば良い。</p>

<ul>
<li>#matches?</li>
<li>#description</li>
<li>#failure_message</li>
<li>#negative_failure_message</li>
</ul>
<pre class="code" data-unlink>require "rack"

<p>module ResponseCodeMatchers
  Rack::Utils::SYMBOL_TO_STATUS_CODE.each do |name, code|
    name = name.to_s.gsub(&quot;&#39;&quot;, &quot;&quot;)
    define_method(&quot;be_#{name}&quot;) do
      ResponseCodeMatcher.new(code.to_s, name)
    end
  end</p>
<p>  class ResponseCodeMatcher
    def initialize(expected, name)
      @expected    = expected
      @description = name.to_s.gsub(&quot;_&quot;, &quot; &quot;)
    end</p>
<pre><code>def matches?(response)
  @actual = response.code
  @actual == @expected
end

def description
  &quot;be #@description&quot;
end

def failure_message
  &quot;expected response code to be #@expected, but #@actual&quot;
end

def negative_failure_message
  &quot;expected response code not to be #@expected, but #@actual&quot;
end</code></pre><p>  end
end</pre></p>
</div>

  </div>
</article>

  </main>
</body>
</html>
