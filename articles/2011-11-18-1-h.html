<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width">
  <title>CSSの整形を正規表現だけで何とかする</title>
  <link href="/articles/2011-11-18-1-h" rel="canonical">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="search" type="application/opensearchdescription+xml" title="r7kamura.com" href="/opensearch.xml">
  <link rel="alternate" type="application/rss+xml" href="/feed.xml">
  <meta property="og:type" content="article">
  <meta property="og:title" content="CSSの整形を正規表現だけで何とかする">
  <meta property="og:url" content="https://r7kamura.com/articles/2011-11-18-1-h">
  <meta property="twitter:card" content="summary_large_image">
  <meta property="og:image" content="http://cdn-ak.f.st-hatena.com/images/fotolife/r/r7kamura/20111118/20111118034036.png?1321555252">
</head>
<body>
  <header>
    <nav>
      <a href="/">トップページ</a>
      <ul>
        <li>
          <a href="/articles">記事</a>
        </li>
        <li>
          <a href="https://google.com/search?q=site:r7kamura.com">検索</a>
        </li>
      </ul>
    </nav>
  </header>
  <main>
    <article>
  <h1>CSSの整形を正規表現だけで何とかする</h1>
  <footer>
    <p>
      <time datetime="2011-11-18T00:00:00+09:00">2011年11月18日</time>
    </p>
  </footer>
  <div>
    <p>最近見た2000行ぐらいのCSS、いろんな人が好き勝手編集していてインデントとかその他もろもろが地獄っぽかったので、正規表現だけで何とかして修正しようとした。</p><p></p>
<div class="section">
<h3>エントロピー</h3>
<p>100行程度の規模なら1行ずつ見ていって修正すれば良いけど、人為的な作業である以上必ずエントロピーは拡大していって、定期的に「すみませんでした、死にます」「いえいえすみませんでした、死にます」「いえいえいえすみ」という感じになってみんなの心が濁っていく。生まれる前に消し去りたい。</p>


</div><div class="section">
<h3>失敗した方法</h3>
<p>最初に考えた方法は、Vimのシンタックス('='キー)に任せて整えてもらう方法だったけど、複数ファイルに適用するときに面倒だし、Vimだしモテないし、行頭行末のスペース程度しか整わないし失敗した。<br>
次に考えた方法は、CSSと互換性のあるSassまたはLessのようなCSS拡張言語を利用して、通常のCSSを再度CSSに変換することで整形されたものを得ようという方法だった。中で何が行われているか分からなくてわりと怖かったのと、filter: progid:DXImageとか特殊なものを認識しないとか、整形形式を細かく調整できないとか色々な問題があって失敗した。よく調べれば回避できるかもしれないし、<a href="http://sassience.com/">Sassience</a>みたいなものもあるので、この方法は今は採用しなくてももう少し調べたい。</p>


</div><div class="section">
<h3>正規表現でやる方法</h3>
<p>最終的に落ち着いた方法は、ヒューリスティックに正規表現書いて静的解析で何とかする方法で、この方法がいまは1番素朴で分かりやすくて良いなという感じがした。git-push時のhooksか、ciで妥当かどうかだけでもチェックするというのが良さそうで、おかしいところが見つかればローカルで適用して書き換えて、gitのdiffとかでざっと確認するというのが手抜き感あって最初は楽で良さそう。何やってるのか分からないけど書き換わってる、みたいなのが1番怖い。あとコーディング規約がコードで書かれているというのは面白いかもしれない。いま適当にスクリプト書いてみたけど、改善の余地がかなりありそう。</p>
<p></p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink>#!/usr/bin/env ruby
# usage: cat hell.css | ruby $0 &gt; heaven.css

<p>str = STDIN.read</p>
<h1 id="末尾の半角スペースを削除">末尾の半角スペースを削除</h1>
<p>str.gsub!(/ +$/, &quot;&quot;)</p>
<h1 id="コロンの前に半角スペース">コロンの前に半角スペース</h1>
<p>str.gsub!(/ +,/, &quot;,&quot;)</p>
<h1 id="中括弧の前に半角スペース">中括弧の前に半角スペース</h1>
<p>str.gsub!(/([^ ]){/, &#39;\1 {&#39;)</p>
<h1 id="中に何も記述のない中括弧を削除">中に何も記述のない中括弧を削除</h1>
<p>str.gsub!(/.<em>{[\s\n]</em>}\n/, &quot;&quot;)</p>
<h1 id="1〜7個のインデントを4個に">1〜7個のインデントを4個に</h1>
<p>str.gsub!(/^ {1,7}([^ ])/, &#39;    \1&#39;)</p>
<h1 id="タブ文字を半角スペースに">タブ文字を半角スペースに</h1>
<p>str.gsub!(/\t/, &quot;    &quot;)</p>
<h1 id="コロンの後に半角スペースを入れる">コロンの後に半角スペースを入れる</h1>
<h1 id="但しコロンの後がdかのときは入れないhttpと、filter-progiddximage対策">但しコロンの後が&#39;D&#39;か&#39;&#39;のときは入れない(http://と、filter: progid:DXImage対策)</h1>
<p>str.gsub!(/^( .*):([^ ^D^/])/, &#39;\1: \2&#39;)</p>
<h1 id="background-urlno-repeat-とかの括弧の後に半角スペース">background: url()no-repeat とかの括弧の後に半角スペース</h1>
<p>str.gsub!(/)no-repeat/, &quot;) no-repeat&quot;)
str.gsub!(/)repeat/, &quot;) repeat&quot;)</p>
<h1 id="先頭がかかのときはインデントしない">先頭が&#39;}&#39;か&#39;#&#39;か&#39;.&#39;のときはインデントしない</h1>
<h1 id="但しカラーコードのぽい場合は無視">但しカラーコードの#ぽい場合は無視</h1>
<h1 id="media-only-screen----を使っている場合は困る">@media only screen ... { } を使っている場合は困る</h1>
<p>str.gsub!(/^ +([.}])/, &#39;\1&#39;)
str.gsub!(/^ +#([^\d^A-F^a-f])/, &#39;#\1&#39;)</p>
<p>print str</pre></p>
</div><div class="section">
<h3>FileMerge.app</h3>
<p>MacだとXcodeにFileMerge.appという差分表示用のアプリが標準で入っていて、大量のCSSの書き換えとかを行った後の比較に役に立つ。</p>
<p><img src="http://cdn-ak.f.st-hatena.com/images/fotolife/r/r7kamura/20111118/20111118034036.png?1321555252"></p>
<br>
<p>結局色々考えてみて、コーディング規約を守ろうとする思いと守らせる環境が必要、みたいな普通の感想を得た。「だいじなのは こころ」って昔やったゲームのエンディングで言ってた。幻獣界に住む女の子が、主人公に対して言った台詞だった気がする。急に思い出してびっくりした。小さかった頃に、登場するモンスターとボス戦の音楽が怖くて、父親にやってもらって後ろで見てたの思い出した。</p>


</div>

  </div>
</article>

  </main>
</body>
</html>
