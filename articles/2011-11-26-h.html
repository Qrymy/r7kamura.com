<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width">
  <title>gitで怪しいファイルを追加すると警告する</title>
  <link href="/articles/2011-11-26-h" rel="canonical">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="search" type="application/opensearchdescription+xml" title="r7kamura.com" href="/opensearch.xml">
  <link rel="alternate" type="application/rss+xml" href="/feed.xml">
  <meta property="og:type" content="article">
  <meta property="og:title" content="gitで怪しいファイルを追加すると警告する">
  <meta property="og:url" content="https://r7kamura.com&#x2F;articles&#x2F;2011-11-26-h">
  <meta property="twitter:card" content="summary">
</head>
<body>
  <header>
    <nav>
      <a href="/">トップページ</a>
      <ul>
        <li>
          <a href="/articles">記事</a>
        </li>
        <li>
          <a href="https://google.com/search?q=site:r7kamura.com">検索</a>
        </li>
      </ul>
    </nav>
  </header>
  <main>
    <article>
  <h1>gitで怪しいファイルを追加すると警告する</h1>
  <footer>
    <p>
      <time datetime="2011-11-26T00:00:00+09:00">2011年11月26日</time>
    </p>
  </footer>
  <div>
    <p>前に<a href="http://r7kamura.hatenablog.com/entry/2011/11/18/004957">CSSの整形を正規表現だけで何とかする</a>というエントリを書いて、このままだと面倒で誰も使わないので、怪しいCSSを書くとgitで警告を表示するようにした。警告を出すだけでファイルの中身は書き換わらない。</p>

<div class="section">
    <h4>使い方</h4>
    <p>.gitattributesとgit-configに設定する。</p>

<pre><code>&lt;pre class=&quot;code lang-txt&quot; data-lang=&quot;txt&quot;&gt;$ echo &#39;*.css filter=reviewcss&#39; &amp;gt;&amp;gt; .gitattributes</code></pre><p>$ git config filter.reviewcss.clean &#39;./sample.rb %f&#39;</pre></p>
<pre><code>&lt;pre class=&quot;code lang-txt&quot; data-lang=&quot;txt&quot;&gt;$ vim hell.css</code></pre><p>$ cat hell.css
    .entry-content a,.entry-content p{
   color:black;
    background: url(&#39;<a href="http://tinyurl.com/8ye9tro&#39;)no-repeat">http://tinyurl.com/8ye9tro&#39;)no-repeat</a>;
    }</p>
<p>$ git add hell.css
<strong>** WARNING!! **</strong>
hell.css:1 中括弧の前に空白がない
hell.css:1 &quot;.&quot;がインデントされている
hell.css:2 末尾に空白がある
hell.css:2 幅1〜3のインデントがある
hell.css:2 コロンの後に空白がない
hell.css:3 括弧の後に空白がない
hell.css:4 &quot;}&quot;がインデントされている</pre></p>
</div>
<div class="section">
    <h4>設計</h4>
    <p>.gitattributesでreviewcssという名前のfilterを定義し、git-configでreviewcssのために利用するコマンドを指定する。%fを付けると、実行時に適用されるファイル名に展開されるので、引数として受け取ってスクリプト内でファイル名を参照する。</p>
<p>.gitattributesを利用するとcommitに含まれてしまうので、.git/info/attributesに記述しても良い。個人的にはgit-configの設定をcommitに含めるというのがしたいけど、どうすればいいのか分からない。.gitconfigをレポジトリルートに置いておけばそれを読んでくれる、みたいな機能がgitに欲しい。<a href="https://github.com/bbatsov/ruby-style-guide">Ruby Style Guide</a>とか、こういうコードスタイル的なものを正規表現で記述できると良さそう。</p>
<p>利用したsample.rbはこんな感じ。</p>

<pre><code>&lt;pre class=&quot;code lang-ruby&quot; data-lang=&quot;ruby&quot;&gt;#!/usr/bin/env ruby</code></pre><p>str        = STDIN.read
filename   = ARGV.first
conditions = {
  /\t/                =&gt; &#39;タブ文字がある&#39;,
  / +$/               =&gt; &#39;末尾に空白がある&#39;,
  / +,/               =&gt; &#39;コロンの前に空白がある&#39;,
  /[^ ]{/            =&gt; &#39;中括弧の前に空白がない&#39;,
  /)\w/              =&gt; &#39;括弧の後に空白がない&#39;,
  /^ .*:[^ ^D^/]/    =&gt; &#39;コロンの後に空白がない&#39;,
  /^ {1,3}[^ ]/       =&gt; &#39;幅1〜3のインデントがある&#39;,
  /^ {5,7}[^ ]/       =&gt; &#39;幅5〜7のインデントがある&#39;,
  /^ +./             =&gt; &#39;&quot;.&quot;がインデントされている&#39;,
  /^ +}/             =&gt; &#39;&quot;}&quot;がインデントされている&#39;,
  /^ +#[^\d^A-F^a-f]/ =&gt; &#39;&quot;#&quot;がインデントされている&#39;
}</p>
<p>warnings = &#39;&#39;
str.lines.with_index do |line, num|
  conditions.each do |regexp, msg|
    warnings &lt;&lt; &quot;#{filename}:#{num + 1} #{msg}\n&quot; if line.match regexp
  end
end</p>
<p>if warnings.size &gt; 0
  STDERR.puts &#39;<strong>** WARNING!! **</strong>&#39;
  STDERR.puts warnings
end</p>
<p>STDOUT.puts str</pre></p>
</div>

  </div>
</article>

  </main>
</body>
</html>
